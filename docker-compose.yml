services:
  # 1. 缓存数据库
  redis:
    image: redis:alpine
    container_name: oj-redis
    command: ["redis-server", "--appendonly", "yes", "--requirepass", "${REDIS_PASSWORD:-deepoj_redis_change_me}"]
    expose:
      - "6379"
    networks:
      - deep-oj-net

  # 2. 工作节点 (Go Wrapper + C++ Core)
  worker:
    build: .
    image: deep-oj:v3
    container_name: oj-worker
    init: true
    command: /app/oj_worker
    cap_add:
      - SYS_ADMIN
      - SYS_RESOURCE
      - SYS_CHROOT
      - SETUID
      - SETGID
    security_opt:
      - no-new-privileges:true
    expose:
      - "50051"
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - ./data/workspace:/data/workspace:rw
    environment:
      - REDIS_URL=oj-redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-deepoj_redis_change_me}
      - DATABASE_URL=postgres://deep_oj:${POSTGRES_PASSWORD:-deepoj_pg_password_change_me}@oj-postgres:5432/deep_oj?sslmode=disable
      - MINIO_ENDPOINT=http://oj-minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-deepoj_minio_user}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-deepoj_minio_password_change_me}
      - MINIO_BUCKET=deep-oj-problems
      - WORKER_ADDR=oj-worker:50051
      - JOB_STREAM_KEY=deepoj:jobs
      - JOB_STREAM_GROUP=deepoj:workers
      - JOB_LEASE_SEC=60
      - JOB_HEARTBEAT_SEC=10
      - JOB_RECLAIM_INTERVAL_SEC=5
      - JOB_RECLAIM_COUNT=16
      - JOB_RECLAIM_GRACE_SEC=15
      - JUDGER_BIN=/app/judge_engine
      - WORKSPACE=/data/workspace
      - WORKER_AUTH_TOKEN=${WORKER_AUTH_TOKEN:-deepoj_worker_token_change_me}
      - ALLOW_INSECURE_WORKER_GRPC=true
    networks:
      - deep-oj-net
    depends_on:
      - redis
      - minio

  # 3. 调度器 (大脑)
  scheduler:
    build: .
    image: deep-oj:v3
    container_name: oj-scheduler
    restart: on-failure
    user: deep_oj
    command: /app/oj_scheduler
    ports:
      - "50052:50052"
    environment:
      - REDIS_URL=oj-redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-deepoj_redis_change_me}
      - WORKER_ADDR=oj-worker:50051
      - PGPASSWORD=${POSTGRES_PASSWORD:-deepoj_pg_password_change_me}
      - DATABASE_URL=postgres://deep_oj:${POSTGRES_PASSWORD:-deepoj_pg_password_change_me}@oj-postgres:5432/deep_oj?sslmode=disable
      - WORKER_AUTH_TOKEN=${WORKER_AUTH_TOKEN:-deepoj_worker_token_change_me}
      - ALLOW_INSECURE_WORKER_GRPC=true
    networks:
      - deep-oj-net
    depends_on:
      - worker
      - redis
      - postgres

  # 4. API Server (大门)
  api:
    build: .
    image: deep-oj:v3
    container_name: oj-api
    restart: on-failure
    user: deep_oj
    command: /app/oj_api
    ports:
      - "18080:18080"
    environment:
      - PORT=18080
      - REDIS_URL=oj-redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-deepoj_redis_change_me}
      - SCHEDULER_ADDR=oj-scheduler:50052
      - PGPASSWORD=${POSTGRES_PASSWORD:-deepoj_pg_password_change_me}
      - DATABASE_URL=postgres://deep_oj:${POSTGRES_PASSWORD:-deepoj_pg_password_change_me}@oj-postgres:5432/deep_oj?sslmode=disable
      - MINIO_ENDPOINT=http://oj-minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-deepoj_minio_user}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-deepoj_minio_password_change_me}
      - MINIO_BUCKET=deep-oj-problems
      - JWT_SECRET=${JWT_SECRET:-dev_jwt_secret_change_me}
      - ADMIN_USERS=${ADMIN_USERS:-admin}
      - METRICS_TOKEN=${METRICS_TOKEN:-}
    networks:
      - deep-oj-net
    depends_on:
      - redis
      - scheduler
      - postgres
      - minio

  # 5. 关系型数据库
  postgres:
    image: postgres:15-alpine
    container_name: oj-postgres
    restart: always
    environment:
      - POSTGRES_USER=deep_oj
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-deepoj_pg_password_change_me}
      - POSTGRES_DB=deep_oj
    volumes:
      - ./sql/migrations:/docker-entrypoint-initdb.d
    expose:
      - "5432"
    networks:
      - deep-oj-net

  # 6. 对象存储 (MinIO)
  minio:
    image: minio/minio:RELEASE.2024-01-18T22-51-28Z
    container_name: oj-minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-deepoj_minio_user}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-deepoj_minio_password_change_me}
    expose:
      - "9000"
      - "9001"
    networks:
      - deep-oj-net

networks:
  deep-oj-net:
    driver: bridge
